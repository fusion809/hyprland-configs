#!/usr/bin/env bash
# Cycles through wallpapers from multiple directories for Hyprpaper

# Directories to search
DIRS=(
    "$HOME/Pictures/Wallpapers"
    "/usr/share/backgrounds"
    "/usr/share/wallpapers"
    "$HOME/.local/share/wallpapers"
    "$HOME/.local/share/backgrounds"
)

echo "Setting = $1"
# Collect all image paths (jpg, png, jpeg)
WALLS=()
for d in "${DIRS[@]}"; do
    if [[ -d "$d" ]]; then
        while IFS= read -r -d '' file; do
            WALLS+=("$file")
        done < <(find "$d" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) -print0 2>/dev/null)
    fi
done

# Exit if no wallpapers found
if [[ ${#WALLS[@]} -eq 0 ]]; then
    notify-send "Wallcycle" "No wallpapers found in configured directories."
    exit 1
fi

if `echo "$1" | grep "[sS]ystematic" &> /dev/null`; then
	# File to remember last wallpaper
	STATE_FILE="$HOME/.cache/hyprpaper-wallstate"

	# Get index of next wallpaper
	if [[ -f "$STATE_FILE" ]]; then
	    LAST_INDEX=$(<"$STATE_FILE")
	else
	    LAST_INDEX=-1
	fi

	NEXT_INDEX=$(( (LAST_INDEX + 1) % ${#WALLS[@]} ))
	echo "$NEXT_INDEX" > "$STATE_FILE"

	WALL="${WALLS[$NEXT_INDEX]}"
elif `echo "$1" | grep "[rR]andom" &> /dev/null `; then
	WALL="${WALLS[RANDOM % ${#WALLS[@]}]}"
else
	echo "Invalid argument given to wallpaper. Must be random, Random, systematic or Systematic!"
	exit 1
fi

# Apply wallpaper
#if ! `pgrep -x "niri" &> /dev/null`; then
#	if ! `pgrep -x "hyprpaper" &> /dev/null`; then
#		hyprpaper &
#	fi
#	hyprctl hyprpaper preload "$WALL"
#	sleep 0.2   # small delay so preload completes
#	hyprctl hyprpaper wallpaper ",$WALL"
#else
	swaybg -i "$WALL" &
#fi
