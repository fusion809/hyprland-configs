#!/usr/bin/env bash
# Cycles through wallpapers from multiple directories for Hyprpaper

# Directories to search
DIRS=(
    "$HOME/Pictures/Wallpapers"
    "/usr/share/backgrounds"
    "/usr/share/wallpapers"
    "$HOME/.local/share/wallpapers"
    "$HOME/.local/share/backgrounds"
)

echo "Setting = $1"
# Collect all image paths (jpg, png, jpeg)
WALLS=()

for dir in "${DIRS[@]}"; do
	echo "dir = $dir"
echo "Found ${#WALLS[@]} wallpapers"
    if [[ -d "$dir" ]]; then
        while IFS= read -r -d '' file; do
            WALLS+=("$file")
        done < <(find "$dir" -type f -name "*.*g" -print0)
    fi
done
echo "Found ${#WALLS[@]} wallpapers"
# Exit if no wallpapers found
if [[ ${#WALLS[@]} -eq 0 ]]; then
    notify-send "Wallcycle" "No wallpapers found in configured directories."
    exit 1
fi
no="${#WALLS[@]}"
# File to remember last wallpaper
STATE_FILE="$HOME/.cache/swaybg-wallstate"
if `echo "$1" | grep "[sS]ystematic" &> /dev/null`; then
	# Get index of next wallpaper
	if [[ -f "$STATE_FILE" ]]; then
	    LAST_INDEX=$(<"$STATE_FILE")
	else
	    LAST_INDEX=-1
	fi

	if `echo "$2" | grep "[pP]revious" &> /dev/null`; then
		NEXT_INDEX=$(( (LAST_INDEX - 1) % ${#WALLS[@]} ))
	else
		NEXT_INDEX=$(( (LAST_INDEX + 1) % ${#WALLS[@]} ))
	fi
	echo "$NEXT_INDEX" > "$STATE_FILE"

	WALL="${WALLS[$NEXT_INDEX]}"
elif `echo "$1" | grep "[rR]andom" &> /dev/null `; then
	NEXT_INDEX=$(( RANDOM % no + 1 ))
	echo "$NEXT_INDEX" > "$STATE_FILE"
	WALL="${WALLS[$NEXT_INDEX]}"
else
	echo "Invalid argument given to wallpaper. Must be random, Random, systematic or Systematic!"
	exit 1
fi
touch ~/.cache/wallpaper-name
echo $WALL > ~/.cache/wallpaper-name
# Apply wallpaper
#if ! `pgrep -x "niri" &> /dev/null`; then
#	if ! `pgrep -x "swaybg" &> /dev/null`; then
#		swaybg &
#	fi
#	hyprctl swaybg preload "$WALL"
#	sleep 0.2   # small delay so preload completes
#	hyprctl swaybg wallpaper ",$WALL"
#else
	swaybg -i "$WALL" &
#fi
